#!/bin/sh
# postinst script for peerbox
#
# see: dh_installdeb(1)

intro() {
	echo "
	 _____               _               
	|  __ \             | |              
	| |__) |__  ___ _ __| |__   _____  __
	|  ___/ _ \/ _ \ '__| '_ \ / _ \ \/ /
	| |  |  __/  __/ |  | |_) | (_) >  < 
	|_|   \___|\___|_|  |_.__/ \___/_/\_\ "

	echo "
	  version: 0.5.7
	  url: www.peerbox.me
	  forum: https://www.peercointalk.org/index.php?board=68.0
	  git: https://github.com/peerchemist/Peerbox
	"	
}

conf() {
	echo "Configuring .ppcoin directory for each user..."
	for _HOME in /home/*?; do
		# Obtain the username
		USER=$( basename ${_HOME} )

		if [ ! -d "$_HOME/.ppcoin" ]; then
			echo "Peercoin directory not found for user $USER! Creating one now."
			mkdir $_HOME/.ppcoin
		fi

		if [ ! -f $_HOME/.ppcoin/ppcoin.conf ]; then
			echo "Peercoin configuration file not found for user $USER! Creating one now."
			echo "rpcuser=rpcuser\nrpcpassword=$(xxd -l 16 -p /dev/urandom)" > $_HOME/.ppcoin/ppcoin.conf
			echo "server=1" >> $_HOME/.ppcoin/ppcoin.conf
		fi
		chown -R ${USER}:${USER} $_HOME/.ppcoin
	done

}

rename() {
	if ! [ "cat /etc/hostname" = "peerbox" ]; then

			echo "
	Do you want to rename this machine to 'peerbox'?
	This will enable automatic discovery on local network as 'peerbox.local' \n\t[yn] "
			read input
			case "$input" in
			n*|N*)
			    echo "
	Poor misguided one. Why are you installing this, then?"
			;;

			y*|Y*)
			hostnamectl --static set-hostname peerbox
			echo "\nYou should reboot now.\n"
			exit
			;;

			esac
	fi	
}

set -e

case "$1" in
    configure)
	systemctl daemon-reload
	##
	intro
	conf
	rename
	##
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0